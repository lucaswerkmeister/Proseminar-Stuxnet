\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{hyperref}
\usepackage[ngerman]{babel}
\usepackage{xcolor}
\usepackage{inconsolata}
\usepackage{listings}
\usepackage{caption}
\usepackage{etoolbox}

\lstdefinestyle{c}{language=C,
basicstyle=\footnotesize\ttfamily,
commentstyle=\color{green},
%identifierstyle=\color{blue},                                                                                                                                                                                                               
keywordstyle=\color{purple},
stringstyle=\color{cyan},
numbers=left,
matchrangestart=t
}

% https://tex.stackexchange.com/a/110195
\makeatletter
\lst@Key{matchrangestart}{f}{\lstKV@SetIf{#1}\lst@ifmatchrangestart}
\def\lst@SkipToFirst{%
    \lst@ifmatchrangestart\c@lstnumber=\numexpr-1+\lst@firstline\fi
    \ifnum \lst@lineno<\lst@firstline
        \def\lst@next{\lst@BeginDropInput\lst@Pmode
        \lst@Let{13}\lst@MSkipToFirst
        \lst@Let{10}\lst@MSkipToFirst}%
        \expandafter\lst@next
    \else
        \expandafter\lst@BOLGobble
    \fi}
\makeatother

\DeclareCaptionFont{white}{\color{white}}
\DeclareCaptionFormat{listing}{
  \colorbox[cmyk]{0.43, 0.35, 0.35,0.01 }{
    \parbox{\textwidth}{\hspace{15pt}#1#2#3}
  }
}
\captionsetup[lstlisting]{ format=listing, labelfont=white, textfont=white, singlelinecheck=false, margin=0pt, font={bf,footnotesize} }

\title{Stuxnet}
\author{Lucas Werkmeister}

\begin{document}

\maketitle

\section{Einführung}

\subsection{Urananreicherung}

Natürlich vorkommendes Uran besteht zu etwa 99\% aus dem Isotop $^{238}\mathrm U$ und zu etwa 1\% aus $^{235}\mathrm U$.
Allerdings ist nur letzteres Isotop zu einer Kernspaltungs-Kettenreaktion fähig;
zur Anwendung des Urans muss sein Anteil also erhöht werden: auf 3-5\% zur Energiegewinnung, für Nuklearwaffen sogar auf über 85\%.
Diese \emph{Anreicherung} des Urans geschieht üblicherweise durch Gaszentrifugen.
Dabei wird das Gas $\mathrm{UH}_6$, Uranhexafluorid, in einer Zentrifuge zur Rotation gebracht.
Fluor kommt als \emph{Reinelement} in der Natur ausschließlich als $^{19}F$ vor;
jegliche Gewichtsvariation unter den $\mathrm{UH}_6$-Molekülen ist also durch das enthaltene Uran verursacht.
In den Zentrifugen sammelt sich also aufgrund der Zentrifugalkraft das $\mathrm{UH}_6$ mit dem erwünschten $^{235}\mathrm U$ innen,
während $\mathrm{UH}_6$ mit $^{238}\mathrm U$ außen entnommen werden kann.
Durch Wiederholung dieses Prozesses in einer Reihe von Zentrifugen wird das Uran angereichert.

\subsection{Steuerung der Anlage}

Die Urananreicherungsanlage wird durch sog. SCADA-Software kontrolliert.
Es ist unbekannt, welche Software genau im Iran zum Einsatz kommt;
nach einer Analyse von Ralph Langner\cite{tkac} handelt es sich aber um keines der üblichen Programme, % TODO exact cite
sondern um eine eigene Software.
Das Programm wird als amateurhaft eingestuft;
seine Autoren seien wohl mit modernem SCADA-Design wenig vertraut. % TODO ref

Das SCADA-Programm steuert allerdings nicht direkt die Zentrifugen;
es ist hauptsächlich ein Werkzeug zur Überwachung des Betriebs. % TKaC 9, Seite
Die direkte Steuerung der Zentrifugen geschieht stattdessen durch sog. Programmable Logic Controllers (PLCs).
Dabei handelt es sich um einfache Prozessoren, die Signale von Sensoren verarbeiten,
um verschiedene Ausgangssignale zu setzen.
In der Anlage von Natanz stammt dieser Teil des Systems von Siemens;
der S7-315 Controller steuert die Rotoren der Zentrifugen selbst (164 Motoren pro Controller), % TKaC 12
der S7-417 Controller die Ventile, welche den Zu- und Abfluss von $\mathrm{UH}_6$ regeln (984 Zentrifugen pro Controller).
Diese PLCs werden durch die Siemens-Software \emph{Step7} (Eigenschreibweise \emph{STEP7}) programmiert;
indem Stuxnet dieses Programm infizierte, konnte es eigene Codeblöcke auf die PLCs schreiben
und somit den physikalischen Angriff durchführen.

\section{Angriffe}

Stuxnet führte zwei Angriffe auf das Anreicherungssystem durch, mit dem Ziel, den Prozess zu sabotieren.
Der erste Angriff stammt aus Stuxnet 0.5;
er war in Stuxnet 1.x zwar noch enthalten, aber nicht mehr erreichbar (toter Code):
in Stuxnet 1.x kommt ausschließlich der zweite Angriff zum Einsatz.
Da Stuxnet 0.5 noch nicht bekannt war, als Stuxnet 1.x untersucht wurde,
hielt man den ersten Angriff damals für ``Work in Progress''.\cite{dossier} % TODO exact ref
Hätten die Stuxnet-Autoren den ersten Angriff ganz aus Stuxnet 1.x entfernt,
so wäre die Verbindung zwischen den beiden Versionen vermutlich nie aufgefallen,
da sie ansonsten nur noch die Verbreitung über Step7 gemein haben.\cite{05} % TODO exact ref

\subsection{1. Angriff}

Der erste Angriff manipuliert die Ventile an den Zentrifugen so,
dass $\mathrm{UH}_6$ zwar ein-, aber nicht mehr abfließen kann.
Dadurch steigt der Druck in den Zentrifugen.
Um dies vor den Operatoren der Anlage zu verbergen,
werden alte Sensordaten abgespielt, die Stuxnet vor Beginn des Angriffs aufzeichnet.

Würde Stuxnet nun nichts weiter tun, so würden die Zentrifugen durch den steigenden Druck schließlich zerstört werden.
Da aber ein Controller sehr viele Zentrifugen regelt (s.~o.), würde dies für viele Zentrifugen fast zeitgleich geschehen;
dieses abnormale Verhalten würde auffallen und Stuxnet in einer Post-Mortem-Analyse vermutlich enttarnt werden.
Stuxnet bricht deshalb den Angriff nach einer Weile ab.
Dadurch verursacht dieser Angriff eine höhere Belastung der Anlage,
die durch eine höhere Ausfallrate der Zentrifugen langfristig den gleichen Schaden verursacht,
aber weniger auffällig ist und Stuxnet daher nicht enttarnt.

\subsection{2. Angriff}

Der zweite Angriff manipuliert die Zentrifugen direkt: die Frequenz der Rotoren wird geändert.
Unter Normalbetrieb laufen die Rotoren auf 63000rpm (1050Hz).
Der Angriff läuft etwa monatlich und wechselt zwischen zwei Zuständen:
im ersten werden die Rotoren für 15 Minuten um gut ein Drittel auf 84600rpm (1410Hz) beschleunigt,
im zweiten werden über einen Zeitraum von 50 Minuten erst nahezu angehalten (120rpm, 2Hz) und dann wieder hochgefahren.
Die IR-1 läuft als \emph{superkritisches} Design im Normalbetrieb bereits über gewissen \emph{kritischen Geschwindigkeiten}
(entsprechend der Resonanzfrequenz des Systems), bei denen durch Resonanzen Vibrationen des Rotors auftreten können.
Wenn der Rotor nun im zweiten Zustand beinahe angehalten und wieder angefahren wird,
durchläuft er auch diese kritischen Frequenzen, mit dem Ergebnis einer noch höheren Ausfallwahrscheinlichkeit.

Stuxnet versucht ebenfalls, WinCC (falls in der Anlage vorhanden) zu verwenden, um den Angriff zwischen mehreren Controllern zu synchronisieren.\cite{dossier} % TODO exact cite
Dazu werden alle fünf Sekunden Pakete über das Netzwerk ausgetauscht; dieser Traffic sollte bei guter Aufsicht der Anlage nicht zu übersehen sein.
Dies, zusammen mit der Tatsache, dass die simultane Beschleunigung oder Abbremsung ganzer Reihen von Zentrifugen gut zu hören ist
(ein Controller steuert viele Zentrifugen, siehe oben) – noch verstärkt durch die Synchronisierung zwischen Controllern –
lässt vermuten, dass zur Entwicklung von Stuxnet 1.x weniger Wert darauf gelegt wurde, unentdeckt zu bleiben.

\section{Verbreitung}

Auch bei der Verbreitung sind signifikante Unterschiede zwischen Stuxnet 0.5 und 1.x festzustellen:
Stuxnet 0.5 verbreitet sich ausschließlich über eine Sicherheitslücke in Step7.
Stuxnet 1.x hingegen weist zusätzlich dazu eine breite Vielfalt von Verbreitungswegen auf:

\begin{itemize}
\item Verbreitung über Memorysticks beim Ausführen von \texttt{autorun.inf}: nur Stuxnet 1.001\cite{dossier} % p. 30
\item Verbreitung über Memorysticks beim Betrachten von Ordnern mit bestimmten \texttt{.lnk}-Dateien (CVE-2010-2568\cite{CVE_lnk}): ab Stuxnet 1.100
\item Verbreitung über WinCC-Server (falls vorhanden) durch Ausnutzung eines hard-coded Server-Passworts (CVE-2010-2772\cite{CVE_wincc})
\item Verbreitung über das SMB-Netzwerkdateisystem
\item Verbreitung über Windows Server Service durch einen Fehler in RPC (Remote Procedure Call) (CVE-2008-4250\cite{CVE_rpc} / MS08-067\cite{MS_rpc})
\item Verbreitung über den Printer Spooler (CVE-2010-2729\cite{CVE_spooler} / MS10-061\cite{MS_spooler})
\end{itemize} % TODO welche davon sind zero-days?

\subsection{Updates erhalten}

Stuxnet verfügte auch einen Mechanismus, um sich selbst zu aktualisieren.
Updates wurden dabei von verschiedenen Servern heruntergeladen.

Für Stuxnet 0.5 wurde eine fiktive Werbeagentur ``MediaSuffix'' beworben, die unter den folgenden Domains erreichbar war:

\begin{itemize}
\item \texttt{smartclick.org}
\item \texttt{best-advertising.net}
\item \texttt{internetadvertising4u.com}
\item \texttt{ad-marketing.net}
\end{itemize}

Die Server hinter den Domains standen in den Vereinigten Staaten, Kanada, Frankreich und Thailand; % 0.5 p. 4
die Domains sind heute alle entweder anderen Betreibern zugeordnet oder unerreichbar.

Normale Besucher sahen dort nur eine nichtssagende Hauptseite\cite{archive_best_advertising};
Stuxnet hingegen konnte auf bestimmten Unterseiten eine Infektion zurückmelden oder Updates anfordern.

Für Stuxnet 1.x wurde eine neue Tarnung genutzt, offenbar für eine Sportwetten-Agentur unter folgenden Domains:

\begin{itemize}
\item \texttt{mypremierfutbol.com}
\item \texttt{todaysfutbol.com}
\end{itemize}

Die Server hinter diesen Domains standen in Malaysia und Dänemark.
Unglücklicherweise ist der damalige Inhalt dieser Seiten unbekannt,
da das Internet Archive sie erst seit 2011 archiviert,
nachdem sie bereits umgeleitet wurden, um weitere Stuxnet-Updates zu verhindern.

Auch Stuxnet 1.x rief bestimmte, konstruierte URLs auf;
der Vorgang ist jedoch komplexer als bei Stuxnet 0.5.
Stuxnet sendet mehr Daten über das Hostsystem (z.~B. Betriebssystemversion, Hostname),
und die Kommunikation ist in beide Richtungen durch XOR-Verknüpfung mit statischen 31-Bit-Schlüsseln geschützt.

\subsection{Updates verteilen}

Da das schlussendliche Zielsystem von Stuxnet aus Sicherheitsgründen nicht direkt am Internet hängt,
müssen Updates über mehrere Stuxnet-Infektionen propagiert werden.

Stuxnet überprüft dazu vor jeder potenziellen Neuinfektion, ob das Zielsystem bereits infiziert ist;
ist dies der Fall, so werden die Versionen verglichen und gegebenenfalls das Ziel- oder eigene System aktualisiert.

Außerdem können Stuxnet-Infektionen auch direkt über das Netzwerk kommunizieren.
Stuxnet 0.5 verwendet dazu Mailslots, einen einfachen Mechanismus zur Interprozesskommunikation;
Stuxnet 1.x started hingegen einen vollständigen RPC-Server und -Client (RPC=Remote Procedure Call), % TODO proper abbreviations?
der verschiedene Programmroutinen bereitstellt und aufruft.

Ferner können File Shares, die wie oben erwähnt zur Infektion genutzt werden,
auch zur Kommunikation und zum Austausch von Stuxnet-DLLs dienen.

\subsection{CVE-2010-2743 Local Privilege Escalation (1.10x)}

Wir wollen nun eine Sicherheitslücke in Windows, die Stuxnet ab Version 1.100 ausnutzte, um im Kernel-Mode zu laufen, genauer untersuchen.
Der Kern der Sicherheitslücke ist ein Zugriff durch Windows auf eine Funktionspointertabelle mit ungeprüftem Index.

Eine Funktionspointertabelle (Function Pointer Table) ist ein Mittel,
um effizient zwischen verschiedenen Verhaltensweisen eines Programms zu wählen.
In C kann sie so aussehen:

\lstinputlisting[
  language=C,
  style=c,
  caption=Definition und Verwendung einer Funktionspointertabelle
]{../functionPointerDemo2/01-harmless.c}

\texttt{execute()} führt eine unterschiedliche Operation aus, je nachdem, welche Funktion über das erste Argument ausgewählt wurde.
Anderer Code muss somit nur noch die Indizes (Opcodes) der einzelnen Operationen kennen, nicht mehr die Funktionen, die tatsächlich ausgeführt werden.

Allerdings ist das Verhalten von \texttt{execute()} undefiniert, wenn ein ungültiger Index eingegeben wird.
In diesem Fall wird Speicher gelesen, der nicht Teil der Funktionspointertabelle ist und vermutlich keinen gültigen Pointer in eine ausführbare Seite enthält;
das Ergebnis ist dann ein Segmentation Fault.

\lstinputlisting[
  language=C,
  style=c,
  firstline=18,
  caption=Ungültige Verwendung der \texttt{execute()}-Funktion
]{../functionPointerDemo2/02-broken.c}

Dies ist allerdings nicht zwingend gegeben; es ist durchaus möglich, dass an der richtigen Stelle ein Funktionspointer liegt,
etwa weil im Quelltext ein anderes Feld dahinter deklariert wurde, das ebenfalls einen Funktionpointer enthält:

\lstinputlisting[
  language=C,
  style=c,
  %linerange={7-7,14-14,20-25},
  caption=Ausführung von unbeabsichtigtem Code
]{../functionPointerDemo2/03-infected.c}

Im Falle von CVE-2010-2743 findet der Sprung in die Funktionspointertabelle innerhalb von \texttt{win32k.sys} beim Laden einer Tastaturbelegung statt.
Hinter der Funktionstabelle liegen hier nicht weitere Funktionspointer, sondern andere Daten.
Stuxnet lädt nun diese Systemdatei und durchsucht diese Daten nach einem geeigneten \texttt{DWORD}, das auch als virtuelle Adresse interpretiert werden kann;
ist ein solches \texttt{DWORD} gefunden, so allokiert Stuxnet Speicher an dieser Adresse und schreibt etwas ausführbaren Code dorthin
(da der Platz an der Stelle begrenzt sein kann, wird nur ein Sprung an eine andere, frei wählbare Adresse geschrieben).
Anschließend schreibt Stuxnet eine speziell korrupte Tastaturbelegungsdatei auf die Festplatte, die einen Sprung an das gefundene \texttt{DWORD} auslösen wird,
und weist dann Windows an, diese Tastaturbelegung zu laden.
Sobald \texttt{win32k.sys} (im Kernel-Mode laufend) versucht, in die Funktionstabelle zu springen,
läuft Stuxnet ebenfalls im Kernel-Mode.

Der Fehler lässt sich sehr einfach beheben, indem der Index in die Funktionspointertabelle vor dem Sprung überprüft wird:

\lstinputlisting[
  language=C,
  style=c,
  linerange=16-23,
  caption=Fehlerbehandlung
]{../functionPointerDemo2/04-protected.c}

\bibliographystyle{plain}
\bibliography{document}
\end{document}
